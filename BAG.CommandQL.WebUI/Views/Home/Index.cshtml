<div class="row">
    <div class="col-md-4">
    </div>
    <div class="col-md-4">
    </div>
    <div class="col-md-4">
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <h2>ChatRequest</h2>
        <p>
            <input type="text" name="name" id="name" />
        </p>
        <p>
            <a class="btn btn-default" onclick="setRequestCall()">start</a>
            <br /><br /><br />
            <img src="~/Content/Images/squares.gif" style="display:none;" class="load" />
            <span class="getChatSession"></span>
        </p>
    </div>
    <div class="col-md-4">


    </div>
    <div class="col-md-4">
        <p>
            <div class="messages">

            </div>
        </p>
        <p>
            <input type="text" name="message" id="message" class="form-control"/>
            <br/>
            <a class="btn btn-default form-control" onclick="setMessageCall()">send</a>
        </p>
    </div>
</div>
@section scripts{
    <script src="~/ViewsScripts/CommandQL.js"></script>
    <script>
        var serverpath = window.location.origin + "/api/commandQL/";
        var chatSession = null;
        var name = null;
        var cmdQL = new BAG.CommandQL({
            handler: window,
            serverpath: serverpath,
            sender: "frontend"
        });

        function setRequestCall() {
            name = $("#name").val();
            $("#name").val("");
            var category = "cat";
            var question = "q";
            var agent = navigator.userAgent;
            var sender = "sender";
            var parameter = "";
            var mandant = "";
            var group = "";
            $(".load").show();
            cmdQL.invoke("setChatRequest", [{
                "mandant": mandant,
                "name": name,
                "category": category,
                "question": question
            }],
            function (data) {
                if (!data)
                    return;
                console.log(data);
                cmdQL.connect();
                cmdQL.subscribe("getChatSession", [{ "id": data.id }]);
                cmdQL.poll();
            });

        }

        function setMessageCall() {
            var message = $("#message").val();
            $("#message").val("");

            cmdQL.invoke("setChatMessage", [{
                "chatSessionId": chatSession.id,
                "message": message,
                "name": name
            }]);

            $(".messages").append("me" + message + "<br/>");
        }

        function getChatSession(data) {
            if (!data)
                return;
            chatSession = data.chatSession;
            $(".load").hide();
            $(".getChatSession").html(JSON.stringify(data.chatSession) + "<br/>");
            cmdQL.unsubscribe("getChatSession");
            cmdQL.subscribe("getChatMessages", [{ "chatMessageId": chatSession.id }]);
        }

        function getRequests(data) {
            console.log(data);
        }

        function ping(data) {
            console.log(data);
            $(".ping").append(data + "<br/>");
        }


    </script>

}
