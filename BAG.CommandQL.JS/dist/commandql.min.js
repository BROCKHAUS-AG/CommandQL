"use strict";var BROCKHAUSAG;!function(BROCKHAUSAG){var CommandQL=function(){function CommandQL(_settings){this.settings={handler:window,sender:"cmdQL.sender",timeout:3e4,completeTimeout:5e3,token:"",headers:null,loggingType:BROCKHAUSAG.LoggingType.None,serverpath:window.location.origin?window.location.origin+"/commandQL/":window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")+"/commandQL/"},this.$index=0,_settings.completeTimeout&&(this.settings.completeTimeout=_settings.completeTimeout),_settings.timeout&&(this.settings.timeout=_settings.timeout),_settings.serverpath&&(this.settings.serverpath=_settings.serverpath),_settings.handler&&(this.settings.handler=_settings.handler),_settings.token&&(this.settings.token=_settings.token),_settings.sender&&(this.settings.sender=_settings.sender),_settings.headers?this.settings.headers=_settings.headers:this.settings.headers={Authorization:"Token "+this.settings.token},_settings.loggingType&&(this.settings.loggingType=_settings.loggingType),_settings.useHttp&&(this.settings.useHttp=_settings.useHttp),this.settings.loggingType&&(BROCKHAUSAG.Logger.loggingType=this.settings.loggingType),BROCKHAUSAG.TransportManager.config(this.settings)}return CommandQL.prototype.subscribe=function(topic,data,success,error){var subscription={topic:topic,parameters:data,success:success,error:error,id:BROCKHAUSAG.Helper.GenerateGuid()};return BROCKHAUSAG.SubscriptionManager.makeSubscription(subscription),this},CommandQL.prototype.subscribeCommand=function(cmd,data,success,error){var subscription={name:cmd,parameters:data,success:success,error:error,id:BROCKHAUSAG.Helper.GenerateGuid()};return BROCKHAUSAG.SubscriptionManager.makeCommandSubscription(subscription),this},CommandQL.prototype.unsubscribe=function(topic,data,id){return BROCKHAUSAG.SubscriptionManager.removeSubscription(topic,data,id),this},CommandQL.prototype.unsubscribeCommand=function(cmd,data,id){return BROCKHAUSAG.SubscriptionManager.removeCommandSubscription(cmd,data,id),this},CommandQL.prototype.unsubscribeAll=function(){return BROCKHAUSAG.SubscriptionManager.removeAllSubscriptions(),this},CommandQL.prototype.unsubscribeAllCommands=function(){return BROCKHAUSAG.SubscriptionManager.removeAllCommandSubscriptions(),this},CommandQL.prototype.invoke=function(cmd,data,success,error){BROCKHAUSAG.Logger.Log("invoke "+cmd,data,BROCKHAUSAG.MessageType.Info),BROCKHAUSAG.TransportManager.invoke(cmd,data,success,error)},CommandQL.prototype.begin=function(){BROCKHAUSAG.TransportManager.begin()},CommandQL.prototype.end=function(){BROCKHAUSAG.TransportManager.end()},CommandQL}();BROCKHAUSAG.CommandQL=CommandQL}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){var Helper=function(){function Helper(){}return Helper.GenerateGuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0;return("x"===c?r:3&r|8).toString(16)})},Helper.Find=function(array,property,value,remove){for(var i=0;i<array.length;i++){var obj=array[i];if(obj[property]===value)return!0===remove&&array.splice(i,1),obj}return null},Helper}();BROCKHAUSAG.Helper=Helper}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){!function(ConnectionStatus){ConnectionStatus[ConnectionStatus.None=0]="None",ConnectionStatus[ConnectionStatus.Connected=1]="Connected",ConnectionStatus[ConnectionStatus.Disconnected=2]="Disconnected",ConnectionStatus[ConnectionStatus.Poll=3]="Poll"}(BROCKHAUSAG.ConnectionStatus||(BROCKHAUSAG.ConnectionStatus={}));var HttpHelper=function(){function HttpHelper(){}return HttpHelper.prototype.makeRequest=function(){},HttpHelper}();BROCKHAUSAG.HttpHelper=HttpHelper}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){var LoggingType;!function(LoggingType){LoggingType[LoggingType.None=0]="None",LoggingType[LoggingType.All=1]="All",LoggingType[LoggingType.Info=2]="Info",LoggingType[LoggingType.Warning=3]="Warning",LoggingType[LoggingType.Error=4]="Error",LoggingType[LoggingType.Debug=5]="Debug"}(LoggingType=BROCKHAUSAG.LoggingType||(BROCKHAUSAG.LoggingType={}));var MessageType;!function(MessageType){MessageType[MessageType.Info=0]="Info",MessageType[MessageType.Warning=1]="Warning",MessageType[MessageType.Error=2]="Error",MessageType[MessageType.Debug=3]="Debug"}(MessageType=BROCKHAUSAG.MessageType||(BROCKHAUSAG.MessageType={}));var Logger=function(){function Logger(){}return Logger.Log=function(message,object,messageType){if(this.loggingType!==LoggingType.None)switch(messageType){case MessageType.Info:console.info(message),object&&console.table&&this.loggingType===LoggingType.Debug&&console.table(object);break;case MessageType.Warning:this.loggingType!==LoggingType.Info&&console.warn(message);break;case MessageType.Error:this.loggingType!==LoggingType.Info&&this.loggingType!==LoggingType.Warning&&console.error(message);break;case MessageType.Debug:this.loggingType===LoggingType.Debug&&console.debug(message)}},Logger}();Logger.loggingType=LoggingType.None,BROCKHAUSAG.Logger=Logger}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){var SubscriptionManager=function(){function SubscriptionManager(){}return SubscriptionManager.makeSubscription=function(subscription){BROCKHAUSAG.Logger.Log("subscribe topic "+subscription.topic,subscription.parameters,BROCKHAUSAG.MessageType.Info),BROCKHAUSAG.TransportManager.serverHandlesTopicSubscriptions()&&BROCKHAUSAG.TransportManager.serverAddSubscription(subscription),this.topicSubscriptions.push(subscription)},SubscriptionManager.makeCommandSubscription=function(subscription){BROCKHAUSAG.Logger.Log("subscribe command "+subscription.name,subscription.parameters,BROCKHAUSAG.MessageType.Info),this.subscriptions.push(subscription)},SubscriptionManager.removeSubscription=function(topic,data,id){BROCKHAUSAG.Logger.Log("unsubscribe topic "+topic,id,BROCKHAUSAG.MessageType.Info);for(var subscriptionObject,i=0;i<this.topicSubscriptions.length;i--)this.topicSubscriptions[i].topic!==topic||id&&this.topicSubscriptions[i].id!==id||data&&data!==this.topicSubscriptions[i].parameters||(subscriptionObject=this.topicSubscriptions[i],this.topicSubscriptions.splice(i,1),BROCKHAUSAG.Logger.Log("unsubscribed topic "+topic,id,BROCKHAUSAG.MessageType.Info));BROCKHAUSAG.TransportManager.serverHandlesTopicSubscriptions()&&subscriptionObject&&BROCKHAUSAG.TransportManager.serverRemoveSubscription(subscriptionObject)},SubscriptionManager.removeCommandSubscription=function(command,data,id){BROCKHAUSAG.Logger.Log("unsubscribe command "+command,id,BROCKHAUSAG.MessageType.Info);for(var i=0;i<this.subscriptions.length;i--)this.subscriptions[i].name!==command||id&&this.subscriptions[i].id!==id||data&&data!==this.subscriptions[i].parameters||(this.subscriptions[i],this.subscriptions.splice(i,1),BROCKHAUSAG.Logger.Log("unsubscribed command "+command,id,BROCKHAUSAG.MessageType.Info))},SubscriptionManager.removeAllSubscriptions=function(){BROCKHAUSAG.Logger.Log("unsubscribeAll",null,BROCKHAUSAG.MessageType.Info),this.topicSubscriptions=[],BROCKHAUSAG.TransportManager.serverHandlesTopicSubscriptions()&&BROCKHAUSAG.TransportManager.serverRemoveAllSubscriptions()},SubscriptionManager.removeAllCommandSubscriptions=function(){BROCKHAUSAG.Logger.Log("unsubscribeAll commands",null,BROCKHAUSAG.MessageType.Info),this.subscriptions=[]},SubscriptionManager}();SubscriptionManager.subscriptions=[],SubscriptionManager.topicSubscriptions=[],BROCKHAUSAG.SubscriptionManager=SubscriptionManager}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){var TransportManager=function(){function TransportManager(){}return TransportManager.config=function(settings){this.settings=settings,"WebSocket"in window&&!0!==settings.useHttp?this.currentTransport=new BROCKHAUSAG.Transport.WebSocketTransport(this.settings):this.currentTransport=new BROCKHAUSAG.Transport.HttpTransport(this.settings)},TransportManager.serverHandlesTopicSubscriptions=function(){return"socket"===this.currentTransport.name},TransportManager.serverAddSubscription=function(subscription){this.currentTransport.addSubscription(subscription)},TransportManager.serverRemoveSubscription=function(subscription){this.currentTransport.removeSubscription(subscription)},TransportManager.serverRemoveAllSubscriptions=function(){this.currentTransport.resetSubscriptions()},TransportManager.invoke=function(command,data,success,error){var invokeData={sender:this.settings.sender,commands:[{name:command,parameters:data,id:BROCKHAUSAG.Helper.GenerateGuid()}]};this.currentTransport.sendData({data:invokeData,success:success,error:error,id:BROCKHAUSAG.Helper.GenerateGuid()})},TransportManager.begin=function(){this.poll(),this.serverHandlesTopicSubscriptions()||this.getTopicUpdates()},TransportManager.end=function(){this.breakPoll=!0,this.breakTopicUpdates=!0},TransportManager.poll=function(){if(!0===this.breakPoll)return void(this.breakPoll=!1);for(var commands=[],_i=0,_a=BROCKHAUSAG.SubscriptionManager.subscriptions;_i<_a.length;_i++){var subscription=_a[_i];if("function"==typeof subscription.parameters){var pollObj={error:subscription.error,success:subscription.success,id:subscription.id,name:subscription.name,parameters:subscription.parameters()};commands.push(pollObj)}else commands.push(subscription)}var pollData={commands:commands,sender:this.settings.sender};this.createPollRequest(pollData)},TransportManager.createPollRequest=function(data){this.currentTransport.sendData({data:data,complete:this.pollCompleteHandler,success:this.pollSuccessHandler,error:this.pollErrorHandler,id:BROCKHAUSAG.Helper.GenerateGuid()})},TransportManager.getTopicUpdates=function(){if(!0===this.breakTopicUpdates)return void(this.breakTopicUpdates=!1);BROCKHAUSAG.SubscriptionManager.topicSubscriptions.length>0&&this.currentTransport.sendData({data:{topics:BROCKHAUSAG.SubscriptionManager.topicSubscriptions,sender:this.settings.sender},complete:this.topicCompleteHandler,error:this.topicErrorHandler,success:this.topicSuccessHandler,id:BROCKHAUSAG.Helper.GenerateGuid()})},TransportManager.topicSuccessHandler=function(data){},TransportManager.topicErrorHandler=function(error){},TransportManager.topicCompleteHandler=function(){setTimeout(function(){TransportManager.getTopicUpdates()},TransportManager.settings.completeTimeout)},TransportManager.pollSuccessHandler=function(data){BROCKHAUSAG.Logger.Log("_success "+data.t+"ms",data,BROCKHAUSAG.MessageType.Info);for(var _i=0,_a=data.commands;_i<_a.length;_i++){var command=_a[_i];if(command.errors&&command.errors.length>0)for(var _b=0,_c=command.errors;_b<_c.length;_b++){var error=_c[_b];BROCKHAUSAG.Logger.Log("call "+command.name+" returns with error "+error,null,BROCKHAUSAG.MessageType.Warning)}else{var fnHandler=null,foundSubscription=BROCKHAUSAG.Helper.Find(BROCKHAUSAG.SubscriptionManager.subscriptions,"id",command.id);fnHandler=foundSubscription&&foundSubscription.success?foundSubscription.success:TransportManager.settings.handler[command.name],"function"==typeof fnHandler?(BROCKHAUSAG.Logger.Log("call "+command.name,command.return,BROCKHAUSAG.MessageType.Info),fnHandler(command.return&&command.return.result?command.return.result:command.return)):BROCKHAUSAG.Logger.Log("function "+command.name+" not found",null,BROCKHAUSAG.MessageType.Warning)}}},TransportManager.pollErrorHandler=function(error){BROCKHAUSAG.Logger.Log("_error ",error,BROCKHAUSAG.MessageType.Error)},TransportManager.pollCompleteHandler=function(){setTimeout(function(){TransportManager.poll()},TransportManager.settings.completeTimeout)},TransportManager}();TransportManager.breakPoll=!1,TransportManager.breakTopicUpdates=!1,BROCKHAUSAG.TransportManager=TransportManager}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){!function(Entities){var CommandQLCommand=function(){function CommandQLCommand(){}return CommandQLCommand}();Entities.CommandQLCommand=CommandQLCommand}(BROCKHAUSAG.Entities||(BROCKHAUSAG.Entities={}))}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){!function(Entities){var CommandQLRequest=function(){function CommandQLRequest(){}return CommandQLRequest}();Entities.CommandQLRequest=CommandQLRequest}(BROCKHAUSAG.Entities||(BROCKHAUSAG.Entities={}))}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){!function(Entities){var CommandQLResponse=function(){function CommandQLResponse(){}return CommandQLResponse}();Entities.CommandQLResponse=CommandQLResponse}(BROCKHAUSAG.Entities||(BROCKHAUSAG.Entities={}))}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){!function(Entities){var CommandQLTopicSubscription=function(){function CommandQLTopicSubscription(){}return CommandQLTopicSubscription}();Entities.CommandQLTopicSubscription=CommandQLTopicSubscription}(BROCKHAUSAG.Entities||(BROCKHAUSAG.Entities={}))}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){!function(Entities){var ResponseDataObject=function(){function ResponseDataObject(){}return ResponseDataObject}();Entities.ResponseDataObject=ResponseDataObject}(BROCKHAUSAG.Entities||(BROCKHAUSAG.Entities={}))}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){!function(Entities){var SendDataObject=function(){function SendDataObject(){}return SendDataObject}();Entities.SendDataObject=SendDataObject}(BROCKHAUSAG.Entities||(BROCKHAUSAG.Entities={}))}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){!function(Entities){var WebSocketMessage=function(){function WebSocketMessage(){}return WebSocketMessage}();Entities.WebSocketMessage=WebSocketMessage}(BROCKHAUSAG.Entities||(BROCKHAUSAG.Entities={}))}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){!function(Transport){var HttpTransport=function(){function HttpTransport(settings){this.settings=settings,this.name="http"}return HttpTransport.prototype.makeRequest=function(sendData){var http=new XMLHttpRequest;if(http.open("POST",this.settings.serverpath,!0),http.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.settings.timeout&&(http.timeout=this.settings.timeout),this.settings.headers)for(var key in Object.keys(this.settings.headers))http.setRequestHeader(key,this.settings.headers[key]);http.onreadystatechange=function(){if(4===http.readyState){if(200===http.status){if(sendData.success){var response=void 0;try{response=JSON.parse(http.responseText)}catch(ex){response=http.responseText}sendData.success(response)}}else sendData.error&&sendData.error("Http error: "+http.status);sendData.complete&&sendData.complete()}},http.send(JSON.stringify(sendData.data))},HttpTransport.prototype.getStatus=function(){return Transport.TransportStatus.Ready},HttpTransport.prototype.sendData=function(sendData){this.makeRequest(sendData)},HttpTransport}();Transport.HttpTransport=HttpTransport}(BROCKHAUSAG.Transport||(BROCKHAUSAG.Transport={}))}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){!function(Transport){!function(TransportStatus){TransportStatus[TransportStatus.None=0]="None",TransportStatus[TransportStatus.Ready=1]="Ready",TransportStatus[TransportStatus.InUse=2]="InUse",TransportStatus[TransportStatus.Disconnected=3]="Disconnected",TransportStatus[TransportStatus.Error=4]="Error",TransportStatus[TransportStatus.Connecting=5]="Connecting"}(Transport.TransportStatus||(Transport.TransportStatus={}))}(BROCKHAUSAG.Transport||(BROCKHAUSAG.Transport={}))}(BROCKHAUSAG||(BROCKHAUSAG={}));var BROCKHAUSAG;!function(BROCKHAUSAG){!function(Transport){var WebSocketTransport=function(){function WebSocketTransport(settings){this.settings=settings,this.name="socket",this.notSendStack=[],this.sendStack=[];var that=this;this.url=-1!==this.settings.serverpath.indexOf("https")?"wss"+this.settings.serverpath.replace("https",""):"ws"+this.settings.serverpath.replace("http",""),this.socket=new WebSocket(this.url),this.socket.onclose=function(){setTimeout(function(){var onopenHandler=that.socket.onopen,oncloseHandler=that.socket.onclose,onmessageHandler=that.socket.onmessage;that.socket=new WebSocket(that.url),that.socket.onopen=onopenHandler,that.socket.onclose=oncloseHandler,that.socket.onmessage=onmessageHandler},1e3)},this.socket.onopen=function(){if(BROCKHAUSAG.SubscriptionManager.subscriptions.length>0){var data={type:"subscribeMany",data:BROCKHAUSAG.SubscriptionManager.topicSubscriptions};that.socket.send(JSON.stringify(data))}if(that.notSendStack.length>0)for(var i=0;i<that.notSendStack.length;i++){var obj=that.notSendStack[i];that.notSendStack.splice(i,1),that.sendData(obj)}},this.socket.onmessage=function(ev){var data=JSON.parse(ev.data);if("executeResult"===data.type){var result=data.data,sendObject=BROCKHAUSAG.Helper.Find(that.sendStack,"id",result.id,!0);sendObject&&(sendObject.success&&sendObject.success(result.data),sendObject.complete&&sendObject.complete())}else if("subscribeResult"===data.type)return}}return WebSocketTransport.prototype.addSubscription=function(subscription){if(1===this.socket.readyState){var data={type:"subscribe",data:subscription};this.socket.send(JSON.stringify(data))}},WebSocketTransport.prototype.removeSubscription=function(subscription){if(1===this.socket.readyState){var data={type:"unsubscribe",data:subscription};this.socket.send(JSON.stringify(data))}},WebSocketTransport.prototype.resetSubscriptions=function(){if(1===this.socket.readyState){var data={type:"reset"};this.socket.send(JSON.stringify(data))}},WebSocketTransport.prototype.getStatus=function(){return 1===this.socket.readyState?Transport.TransportStatus.Ready:Transport.TransportStatus.Connecting},WebSocketTransport.prototype.sendData=function(sendData,poll){if(1===this.socket.readyState){this.sendStack.push(sendData);var data={type:"execute",data:sendData};this.socket.send(JSON.stringify(data))}else!0!==poll?this.notSendStack.push(sendData):sendData.error&&sendData.error("No socket connection is open")},WebSocketTransport}();Transport.WebSocketTransport=WebSocketTransport}(BROCKHAUSAG.Transport||(BROCKHAUSAG.Transport={}))}(BROCKHAUSAG||(BROCKHAUSAG={}));